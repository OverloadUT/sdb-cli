# SDB Specification (Canonical)

This document defines the canonical behavior of the SDB CLI. It is the source of truth; code should conform to this spec.

## 1) Purpose and Scope
- SDB (Spectra DB) is a local, file-based database for structured records stored as JSON Lines (JSONL).
- The CLI provides CRUD operations, schema validation, filtering, and human-readable output.
- Scope is single-node, local filesystem usage. No server, networking, or multi-user auth is included.

## 2) Terminology
- **Database folder**: A directory containing `schema.json` and `data.jsonl`.
- **Record**: A JSON object consisting of reserved fields plus user fields.
- **Reserved fields**: Fields managed by SDB and not settable by users. Schemas cannot define or require reserved fields.

## 3) Files and Storage Format
- `schema.json`: JSON Schema (Draft 2020-12) describing user data fields.
- `data.jsonl`: Active records, one JSON object per line.
- `data.deleted.jsonl`: Soft-deleted records, one JSON object per line (includes `_deleted`).
- `.sdb.lock`: Lock file used to serialize write operations.
- SDB rewrites `data.jsonl` on add/update/soft delete/hard delete. Soft delete also appends to `data.deleted.jsonl`.

## 4) Record Model
Reserved fields:
- `_id` (string): ULID identifier generated by SDB.
- `_created` (string): ISO 8601 timestamp of creation.
- `_updated` (string): ISO 8601 timestamp of last update.
- `_deleted` (string, optional): ISO 8601 timestamp of soft delete (only present in deleted records).

User fields:
- Any JSON values allowed by the schema.
- Field names MUST NOT begin with `_`.

## 5) Schema Rules
- Schema must be a JSON object with `type: "object"` and `properties`.
- SDB validates user data against schema on `add`, `update`, and `validate`.
- Schema defaults are applied on `add` (only for missing fields).
- SDB does not modify schema or backfill defaults on existing records.

## 6) Output Model
- Default output is JSON for machine parsing.
- `--human` switches to human-readable text output.
- JSON output is consistent across commands; human output is best-effort for local inspection.

## 7) Commands and Behavior
### `sdb init <folder> --schema <path>`
- Creates a database folder with `schema.json` and `data.jsonl`.
- Fails if already initialized unless `--force` is supplied.
- `--dry-run` reports planned operations without writing.

### `sdb add <folder> [--field value ...]`
- Adds a new record with a generated `_id`.
- Validates against schema after applying defaults.
- `--dry-run` reports the record and planned write.
- Field arguments accept both `--field value` and `--field=value`.

### `sdb list <folder>`
- Lists records. By default, soft-deleted records are excluded.
- `--include-deleted` includes records from `data.deleted.jsonl`.
- `--filter <expression>` applies filter syntax (see Section 9).
- `--format json|ids` controls JSON output shape.
- `--format table` is human-only and equivalent to `--human` for list output.
- `--sort <field>` sorts by a field (`created`, `updated`, `id`, or any field).
- `--order asc|desc` controls sort order (default `asc`).
- `--limit <n>` limits the number of records returned after filtering/sorting.
- `--created-within <duration>` includes only records created within that duration.
- `--updated-within <duration>` includes only records updated within that duration.
- `--deleted-within <duration>` includes only records deleted within that duration (requires `--include-deleted`).

### `sdb get <folder> <id...>`
- Returns one or more records by `_id`.
- If a record is soft-deleted, response includes metadata marking it deleted.
- If any requested ID is missing, the command fails (no partial success).

### `sdb update <folder> <id...> [--field value ...]`
- Updates user fields on one or more records.
- Preserves `_id` and `_created`; sets `_updated` to now.
- Fails if any target record is soft-deleted or missing (no partial success).
- Validates updated user data against schema.
- `--dry-run` reports changes without writing.
- Field arguments accept both `--field value` and `--field=value`.

### `sdb delete <folder> <id...>`
- Requires `--force` for any delete.
- Soft delete by default (appends record to `data.deleted.jsonl` with `_deleted` and removes it from `data.jsonl`).
- `--hard` permanently removes the record from active and deleted storage.
- Soft delete fails if any target record is already deleted or missing (no partial success).
- Hard delete fails if any target record is missing (no partial success).
- `--dry-run` reports planned action without writing.

### `sdb count <folder>`
- Counts records, with optional filter and include-deleted semantics (includes deleted file).

### `sdb schema <folder>`
- Returns the schema (`schema.json`).

### `sdb validate <folder>`
- Validates active records against the schema (deleted records are excluded).
- If any record is invalid, outputs a JSON error with code `SCHEMA_VALIDATION_FAILED`. The error context includes `validationErrors` as an array of `{ id, errors[] }`.
- Exits with non-zero status if any record is invalid.

### `sdb gc <folder>`
- Removes records from `data.deleted.jsonl`.
- Requires either `--age <duration>` or `--all`.
- `--age` supports `s`, `m`, `h`, `d`, `w` suffixes.
- Skips records with invalid or missing `_deleted` timestamps.
- Requires `--force` and supports `--dry-run`.

## 8) Output and Exit Codes
- Success is JSON to stdout unless `--human` is used.
- Errors are JSON to stderr with `success: false`.
- Exit codes:
  - `0` success
  - `1` general error
  - `2` invalid usage / schema validation error
  - `3` permission denied / safety check failed
  - `4` resource not found

## 9) Filter Syntax
SDB supports a subset of jq-like expressions:
- Equality/inequality: `.field == "value"`, `.field != "value"`
- Numeric comparisons: `.count > 10`, `.count <= 5`
- Boolean values: `.active == true`
- Existence: `.field`, `not .field`
- Array contains: `.tags | contains("urgent")`
- Logical composition: `and`, `or`
- Optional wrapper: `select(<expression>)`
Notes:
- Only top-level field names (`\w+`) are supported.
- Parentheses are only parsed for `select(...)` and operator splitting.

## 10) Locking and Atomicity
- Write operations use `.sdb.lock` to prevent concurrent writes.
- If a lock exists and is older than 2 minutes, it is treated as stale and removed.
- Writes are atomic via a temp file + rename.

## 11) Safety and Validation
- Destructive operations require explicit `--force`.
- Reserved fields cannot be set by user inputs.
- Schemas cannot define or require reserved fields.
- Folder path traversal attempts are rejected in `init`.

## 12) Non-Goals
- No network service, replication, or multi-user permissions.
- No partial reads or streaming output.
- No schema migrations or automatic record repair.

## 13) Compatibility and Extensibility
- Records are standard JSON; any tooling that understands JSONL can read them.
- The CLI is the canonical interface; `dist/` is build output only.
