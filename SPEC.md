# SDB Specification (Canonical)

This document defines the canonical behavior of the SDB CLI as implemented in this repository. It is intended to be edited as the source of truth; code should conform to this spec.

## 1) Purpose and Scope
- SDB is a local, file-based database for structured records stored as JSON Lines (JSONL).
- The CLI provides CRUD operations, schema validation, filtering, and human-readable output.
- Scope is single-node, local filesystem usage. No server, networking, or multi-user auth is included.

## 2) Terminology
- **Database folder**: A directory containing `schema.json` and `data.jsonl`.
- **Record**: A JSON object consisting of reserved fields plus user fields.
- **Reserved fields**: Fields managed by SDB and not settable by users.

## 3) Files and Storage Format
- `schema.json`: JSON Schema (Draft 2020-12) describing user data fields.
- `data.jsonl`: One JSON object per line. Each line is a complete record.
- `.sdb.lock`: Lock file used to serialize write operations.
- SDB rewrites the entire `data.jsonl` on each write (append is logical, not physical).

## 4) Record Model
Reserved fields:
- `_id` (string): ULID identifier generated by SDB.
- `_created` (string): ISO 8601 timestamp of creation.
- `_updated` (string): ISO 8601 timestamp of last update.
- `_deleted` (string, optional): ISO 8601 timestamp of soft delete.

User fields:
- Any JSON values allowed by the schema.
- Field names MUST NOT begin with `_`.

## 5) Schema Rules
- Schema must be a JSON object with `type: "object"` and `properties`.
- SDB validates user data against schema on `add`, `update`, and `validate`.
- Schema defaults are applied on `add` (only for missing fields).
- SDB does not modify schema or backfill defaults on existing records.

## 6) Commands and Behavior
### `sdb init <folder> --schema <path>`
- Creates a database folder with `schema.json` and `data.jsonl`.
- Fails if already initialized unless `--force` is supplied.
- `--dry-run` reports planned operations without writing.

### `sdb add <folder> [--field value ...]`
- Adds a new record with a generated `_id`.
- Validates against schema after applying defaults.
- `--dry-run` reports the record and planned write.

### `sdb list <folder>`
- Lists records. By default, soft-deleted records are excluded.
- `--include-deleted` includes soft-deleted records.
- `--filter <expression>` applies filter syntax (see Section 8).
- `--format json|table|ids` controls output shape.

### `sdb get <folder> <id>`
- Returns a single record by `_id`.
- If the record is soft-deleted, response includes metadata marking it deleted.

### `sdb update <folder> <id> [--field value ...]`
- Updates user fields on a record.
- Preserves `_id` and `_created`; sets `_updated` to now.
- Fails if record is soft-deleted.
- Validates updated user data against schema.
- `--dry-run` reports changes without writing.

### `sdb delete <folder> <id>`
- Requires `--force` for any delete.
- Soft delete by default (sets `_deleted` and `_updated`).
- `--hard` permanently removes the record.
- `--dry-run` reports planned action without writing.

### `sdb count <folder>`
- Counts records, with optional filter and include-deleted semantics.

### `sdb schema <folder>`
- Returns the schema (`schema.json`).

### `sdb validate <folder>`
- Validates all records against the schema.
- Exits with non-zero status if any record is invalid.

## 7) Output and Exit Codes
- Success is JSON to stdout unless `--human` is used.
- Errors are JSON to stderr with `success: false`.
- Exit codes:
  - `0` success
  - `1` general error
  - `2` invalid usage / validation error
  - `3` permission denied / safety check failed
  - `4` resource not found

## 8) Filter Syntax
SDB supports a subset of jq-like expressions:
- Equality/inequality: `.field == "value"`, `.field != "value"`
- Numeric comparisons: `.count > 10`, `.count <= 5`
- Boolean values: `.active == true`
- Existence: `.field`, `not .field`
- Array contains: `.tags | contains("urgent")`
- Logical composition: `and`, `or`
- Optional wrapper: `select(<expression>)`
Notes:
- Only top-level field names (`\w+`) are supported.
- Parentheses are only parsed for `select(...)` and operator splitting.

## 9) Locking and Atomicity
- Write operations use `.sdb.lock` to prevent concurrent writes.
- If a lock exists and is older than 30 seconds, it is treated as stale and removed.
- Writes are atomic via a temp file + rename.

## 10) Safety and Validation
- Destructive operations require explicit `--force`.
- Reserved fields cannot be set by user inputs.
- Folder path traversal attempts are rejected in `init`.

## 11) Non-Goals
- No network service, replication, or multi-user permissions.
- No partial reads or streaming output.
- No schema migrations or automatic record repair.

## 12) Compatibility and Extensibility
- Records are standard JSON; any tooling that understands JSONL can read them.
- The CLI is the canonical interface; `dist/` is build output only.
